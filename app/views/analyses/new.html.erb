<% content_for :head do %>
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="<%= request.original_url %>">
<% end %>


<div data-controller="analysis">
  <div class="container-fluid py-5">
    <div class="row justify-content-center">
      <div class="col-12 col-xl-10">

        <!-- Header Section -->
        <div class="text-center mb-5">
          <h1 class="display-5 fw-bold text-primary mb-3">StaffCraft Hiring Analysis</h1>
          <p class="lead text-muted mb-4">Get AI-powered recommendations on whether to hire talent or implement automation</p>
        </div>

        <!-- Progress Steps -->
        <div class="steps-container mb-5">
          <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-title">Company</div>
          </div>
          <div class="step" data-step="2">
            <div class="step-number">2</div>
            <div class="step-title">Role</div>
          </div>
          <div class="step" data-step="3">
            <div class="step-number">3</div>
            <div class="step-title">Goals</div>
          </div>
          <div class="step" data-step="4">
            <div class="step-number">4</div>
            <div class="step-title">Tools</div>
          </div>
          <div class="step" data-step="5">
            <div class="step-number">5</div>
            <div class="step-title">Compliance</div>
          </div>
        </div>

        <!-- Main Form Card -->
        <div class="card border-0 shadow-lg">
          <div class="card-body p-0">
            <%= simple_form_for @analysis, html: { class: "needs-validation", novalidate: true, id: "staffcraft-form" } do |f| %>

              <%= f.simple_fields_for :form_data do |ff| %>
                <!-- Section 1: Company Snapshot -->
                <div class="form-section" id="section-1">
                  <div class="section-header bg-primary text-white p-4">
                    <h4 class="mb-0"><i class="fas fa-building me-3"></i>Company Snapshot</h4>
                    <small class="opacity-75">Tell us about your company</small>
                  </div>

                  <div class="section-content bg-light p-5">
                    <div class="row g-4">
                      <div class="col-md-6">
                        <%= ff.input :company_name,
                            label: "Company Name",
                            input_html: {
                              class: "form-control form-control-lg",
                              placeholder: "Enter your company name",
                              required: true
                            },
                            required: true %>
                      </div>
                      <div class="col-md-6">
                        <%= ff.input :company_url,
                            label: "Company Website",
                            input_html: {
                              class: "form-control form-control-lg",
                              type: "url",
                              placeholder: "https://your-company.com"
                            } %>
                      </div>
                    </div>

                    <div class="row g-4 mt-2">
                      <div class="col-md-6">
                        <%= ff.input :industry_business_model,
                            as: :select,
                            collection: [
                              ['SaaS B2B', 'saas_b2b'],
                              ['SaaS B2C', 'saas_b2c'],
                              ['E-commerce', 'ecommerce'],
                              ['Consulting', 'consulting'],
                              ['Marketing/Creative Agency', 'marketing_agency'],
                              ['PR/Communications Agency', 'pr_agency'],
                              ['Recruitment/Staffing Agency', 'recruitment_agency'],
                              ['Services B2B', 'services_b2b'],
                              ['Services B2C', 'services_b2c'],
                              ['Real Estate', 'real_estate'],
                              ['Marketplace', 'marketplace'],
                              ['Non-profit', 'nonprofit'],
                              ['Other', 'industry_other']
                            ],
                            label: "Industry & Business Model",
                            input_html: {
                              class: "form-select form-select-lg",
                                data: {
                                  controller: "analysis",
                                  action: "change->analysis#toggleOtherField",
                                  toggle_target: "industry_other_group"
                                }
                            },
                            include_blank: "Select your industry"%>
                      </div>
                      <div class="col-md-6">
                        <div class="conditional-field-group" id="industry_other_group" style="display: none;">
                          <%= ff.input :industry_other,
                              label: "If Other Industry, specify:",
                              input_html: {
                                class: "form-control form-control-lg",
                                placeholder: "Specify your industry"
                              } %>
                        </div>
                      </div>

                      <div class="col-md-4">
                        <%= ff.input :annual_revenue_band,
                            as: :select,
                            collection: [
                              ['Pre-revenue', 'pre_revenue'],
                              ['< $500k', 'under_500k'],
                              ['$500k–$2M', 'k500_2m'],
                              ['$2–10M', 'm2_10m'],
                              ['$10–50M', 'm10_50m'],
                              ['> $50M', 'over_50m']
                            ],
                            label: "Annual Revenue",
                            input_html: { class: "form-select form-select-lg" },
                            include_blank: "Select revenue range" %>
                      </div>

                      <div class="col-md-4">
                        <%= ff.input :company_size,
                            as: :select,
                            collection: [
                              ['Solo-founder', 'solo'],
                              ['2–5 employees', 'size_2_5'],
                              ['6–20 employees', 'size_6_20'],
                              ['21–50 employees', 'size_21_50'],
                              ['51–100 employees', 'size_51_100'],
                              ['100+ employees', 'size_100_plus']
                            ],
                            label: "Company Size",
                            input_html: { class: "form-select form-select-lg" },
                            include_blank: "Select company size" %>
                      </div>
                    </div>

                    <div class="row g-4 mt-2">
                      <div class="col-md-6">
                        <div class="form-check form-check-lg mb-3">
                          <%= ff.input :has_internal_it_team,
                              as: :boolean,
                              label: "Internal IT/Devs team",
                              input_html: {
                                class: "form-check-input form-check-input-lg",
                                data: {
                                  controller: "analysis",
                                  action: "change->analysis#toggleOtherField",
                                  toggle_target: "it_team_details"
                                }
                              } %>
                        </div>
                      </div>
                    </div>
                        <!-- Campos condicionales -->
                        <div class="conditional-field-group" id="it_team_details" style="display: none;">
                          <div class="row g-4 mt-2">
                            <div class="col-md-6">
                              <%= ff.input :team_skills_level,
                                  as: :select,
                                  collection: [
                                   ['Junior (Basic scripts, simple tools)', :junior],
                                   ['Mid-level (API integration, custom tools)', :mid_level],
                                   ['Senior (Full-stack, complex systems)', :senior],
                                   ['Expert (System architecture, AI/ML)', :expert]
                                  ],
                                  label: "Team's Skills Level",
                                  input_html: { class: "form-select" },
                                  include_blank: "Select skill level" %>
                            </div>

                            <div class="col-md-6">
                              <%= ff.input :team_available_hours,
                                  as: :select,
                                  collection: [
                                    ['< 5 hours/week', :under_5],
                                    ['5-15 hours/week', :h5_15],
                                    ['15-30 hours/week', :h15_30],
                                    ['30+ hours/week (dedicated)', :over_30]
                                  ],
                                  label: "Team's Total Available Hours",
                                  input_html: { class: "form-select" },
                                  include_blank: "Select availability" %>
                            </div>
                           </div>
                          </div>
                        </div>
                        <div class="section-footer p-4 text-center">
                          <button type="button" data-action="click->analysis#showSection" data-section-number-value="2">
                            Continue to Role Details <i class="fas fa-arrow-right ms-2"></i>
                          </button>
                        </div>
                      </div>
                  </div>
                </div>
                </div>

                <!-- Section 2: Role to Hire -->
                <!-- Section 2: Role to Hire -->
                <div class="form-section d-none" id="section-2">
                  <div class="section-header bg-success text-white p-4">
                    <h4 class="mb-0"><i class="fas fa-user-tie me-3"></i>Role to Hire</h4>
                    <small class="opacity-75">Define the position you need</small>
                  </div>

                  <div class="section-content bg-light p-5">
                    <!-- Primera fila: Título y Deadline -->
                    <div class="row g-4">
                      <div class="col-md-6">
                        <%= ff.input :role_title,
                            label: "Role Title",
                            input_html: {
                              class: "form-control form-control-lg",
                              placeholder: "e.g., Growth Marketer, Senior Developer",
                              required: true
                            },
                            required: true %>
                      </div>
                      <div class="col-md-6">
                        <%= ff.input :deadline_to_fill,
                            as: :select,
                            collection: [
                              ['ASAP', :asap],
                              ['< 1 month', :under_1_month],
                              ['< 3 months', :under_3_months],
                              ['< 6 months', :under_6_months],
                              ['Just exploring', :exploring]
                            ],
                            label: "Deadline to Fill Role",
                            input_html: { class: "form-select form-select-lg" },
                            include_blank: "Select timeline" %>
                      </div>
                    </div>

                    <!-- Segunda fila: Seniority, Employment Type, Budget -->
                    <div class="row g-4 mt-2">
                      <div class="col-md-4">
                        <%= ff.input :seniority_level,
                            as: :select,
                            collection: [
                              ['Junior (0-2 years)', :junior],
                              ['Mid-level (2-5 years)', :mid],
                              ['Senior (5+ years)', :senior],
                              ['Expert (10+ years)', :expert]
                            ],
                            label: "Seniority Level",
                            input_html: { class: "form-select form-select-lg" },
                            include_blank: "Select experience level" %>
                      </div>
                      <div class="col-md-4">
                        <%= ff.input :employment_type,
                            as: :select,
                            collection: [
                              ['Full-time employee', :full_time],
                              ['Part-time employee', :part_time],
                              ['Contractor / Freelancer', :contractor],
                              ['Fractional executive', :fractional]
                            ],
                            label: "Employment Type",
                            input_html: { class: "form-select form-select-lg" },
                            include_blank: "Select employment type" %>
                      </div>
                      <div class="col-md-4">
                        <%= ff.input :monthly_budget_ceiling,
                            as: :select,
                            collection: [
                              ['Up to $800', :up_to_800],
                              ['$800 - $2,000', :under_2k],
                              ['$2,000 - $5,000', :k2_5k],
                              ['$5,000 - $10,000', :k5_10k],
                              ['$10,000 - $20,000', :k10_20k],
                              ['$20,000+', :over_20k]
                            ],
                            label: "Monthly Budget",
                            input_html: { class: "form-select form-select-lg" },
                            include_blank: "Select budget range" %>
                      </div>
                    </div>

                    <!-- Tercera fila: Location Type y On-site Location -->
                    <div class="row g-4 mt-2">
                      <div class="col-md-6">
                        <%= ff.input :location_type,
                            as: :select,
                            collection: [
                              ['Remote (anywhere)', :remote_anywhere],
                              ['Remote (specific timezone)', :remote_timezone],
                              ['Hybrid', :hybrid],
                              ['On-site', :onsite]
                            ],
                            label: "Location Type",
                            input_html: {
                              class: "form-select form-select-lg",
                              data: {
                                action: "change->analysis#toggleOtherField",
                                toggle_target: "timezone_details_group"
                              }
                            },
                            include_blank: "Select location type" %>
                      </div>
                      <div class="col-md-6">
                        <%= ff.input :onsite_location,
                            label: "On-site Location (if aplicable)",
                            input_html: {
                              class: "form-control form-control-lg",
                              placeholder: "e.g., New York, NY"
                            } %>
                      </div>
                    </div>

                    <!-- Campo condicional: Working Hours (solo para remote timezone) -->
                    <div class="conditional-field-group" id="timezone_details_group" style="display: none;">
                      <div class="row g-4 mt-2">
                        <div class="col-md-6">
                          <%= ff.input :working_hours_timezone,
                              as: :select,
                              collection: TIMEZONE_OPTIONS,
                              label: "Required Working Hours/Timezone",
                              input_html: { class: "form-select form-control-lg" },
                              include_blank: "Select timezone" %>
                        </div>
                      </div>
                    </div>

                    <!-- Cuarta fila: Department -->
                    <div class="row g-4 mt-2">
                      <div class="col-md-6">
                        <%= ff.input :department_function,
                            as: :select,
                            collection: [
                              ['Sales', :sales],
                              ['Marketing', :marketing],
                              ['Product', :product],
                              ['Engineering', :engineering],
                              ['Operations', :ops],
                              ['Finance', :finance],
                              ['Customer Success', :customer_success],
                              ['HR / People', :hr_people],
                              ['Legal / Compliance', :legal_compliance],
                              ['Other', :department_other]
                            ],
                            label: "Department",
                            input_html: {
                              class: "form-select form-select-lg",
                              data: {
                                action: "change->analysis#toggleOtherField",
                                toggle_target: "department_other_group"
                              }
                            },
                            include_blank: "Select department" %>
                      </div>
                      <!-- Campos condicionales: Department Other -->
                      <div class="col-md-6">
                        <div class="conditional-field-group" id="department_other_group" style="display: none;">
                            <%= ff.input :department_other,
                                label: "If Other Department, specify:",
                                input_html: {
                                  class: "form-control form-control-lg",
                                  placeholder: "Specify department"
                                } %>
                          </div>
                      </div>
                    </div>

                    <!-- Cuarta fila: Must-Have Skills (Tag List) -->
                    <div class="row g-4 mt-2">
                      <div class="col-md-12">
                        <label class="form-label">Must-Have Skills</label>
                        <div class="skills-input-container">
                          <div class="skills-tags mb-2" id="skills-tags"></div>
                          <div class="input-group position-relative">
                            <input type="text"
                                  class="form-control form-control-lg"
                                  id="skills-input"
                                  placeholder="Type or select a skill (e.g., JavaScript, Project Management)"
                                  data-action="keydown->analysis#addSkill input->analysis#filterSkills focus->analysis#showSuggestions"
                                  autocomplete="off">
                            <button class="btn btn-outline-secondary" type="button" data-action="click->analysis#addSkillFromInput">
                              <i class="fas fa-plus"></i> Add
                            </button>

                            <!-- Dropdown de sugerencias -->
                            <div class="skills-suggestions position-absolute w-100 bg-white border rounded shadow-sm"
                                id="skills-suggestions"
                                style="display: none; top: 100%; z-index: 1000; max-height: 200px; overflow-y: auto;">
                            </div>
                          </div>
                          <small class="text-muted">Press Enter, click Add, or select from suggestions. Click on tags to remove them.</small>

                          <!-- Hidden field para enviar los skills -->
                          <%= ff.input :must_have_skills,
                              as: :hidden,
                              input_html: { id: "must_have_skills_hidden" } %>
                        </div>
                      </div>
                    </div>

                    <!-- Quinta fila: Compensation -->
                    <div class="row g-4 mt-2">
                      <div class="col-md-6">
                        <label class="form-label">Preferred Compensation Model</label>
                        <div class="compensation-checkboxes">
                          <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox"  name="analysis[form_data_attributes][preferred_compensation_model][]" value="salary" id="comp_salary">
                            <label class="form-check-label" for="comp_salary">Fixed Salary</label>
                          </div>
                          <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox"  name="analysis[form_data_attributes][preferred_compensation_model][]" value="hourly" id="comp_hourly">
                            <label class="form-check-label" for="comp_hourly">Hourly Rate</label>
                          </div>
                          <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox"  name="analysis[form_data_attributes][preferred_compensation_model][]" value="project" id="comp_project">
                            <label class="form-check-label" for="comp_project">Project-based</label>
                          </div>
                          <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox"  name="analysis[form_data_attributes][preferred_compensation_model][]" value="equity" id="comp_equity">
                            <label class="form-check-label" for="comp_equity">Equity/Stock Options</label>
                          </div>
                          <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox"  name="analysis[form_data_attributes][preferred_compensation_model][]" value="commission" id="comp_commission">
                            <label class="form-check-label" for="comp_commission">Commission/Bonus</label>
                          </div>
                          <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox"  name="analysis[form_data_attributes][preferred_compensation_model][]" value="other" id="comp_other" data-action="change->analysis#toggleOtherField" data-toggle-target="compensation_other_group">
                            <label class="form-check-label" for="comp_other">Other</label>
                          </div>
                        </div>

                        <!-- Campo condicional para compensation other -->
                        <div class="conditional-field-group mt-3" id="compensation_other_group" style="display: none;">
                          <%= ff.input :compensation_other,
                              label: "If Other, specify:",
                              input_html: {
                                class: "form-control",
                                placeholder: "Specify compensation model"
                              } %>
                        </div>
                      </div>

                      <div class="col-md-6">
                        <%= ff.input :contract_length,
                            label: "Contract Length (if applicable)",
                            input_html: {
                              class: "form-control form-control-lg",
                              placeholder: "e.g., 6 months, 1 year, Ongoing"
                            } %>
                      </div>
                    </div>
                  </div>

                  <div class="section-footer p-4 text-center">
                    <button type="button" class="btn btn-outline-secondary btn-lg me-3"
                      data-action="click->analysis#showSection"
                      data-section-number-value="1">
                      <i class="fas fa-arrow-left me-2"></i>Back
                    </button>
                    <button type="button" data-action="click->analysis#showSection" data-section-number-value="3">
                      Continue to Goals <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                  </div>
                </div>

                <!-- Section 3: Pain Points & Goals -->
                <div class="form-section d-none" id="section-3">
                  <div class="section-header bg-warning text-dark p-4">
                    <h4 class="mb-0"><i class="fas fa-target me-3"></i>Pain Points & Goals</h4>
                    <small class="opacity-75">What challenges are you solving?</small>
                  </div>

                  <div class="section-content bg-light p-5">
                    <div class="row g-4">
                      <div class="col-md-12">
                        <%= ff.input :desired_outcome,
                            as: :text,
                            label: "Desired Outcome / Success Definition",
                            input_html: {
                              class: "form-control form-control-lg",
                              rows: 4,
                              placeholder: "Describe what success looks like for this role..."
                            } %>
                      </div>
                    </div>

                    <div class="row g-4 mt-2">
                      <div class="col-md-6">
                        <%= ff.input :current_kpi_baseline,
                            label: "Current KPI Baseline",
                            input_html: {
                              class: "form-control form-control-lg",
                              placeholder: "e.g., Avg. 4 hrs per ticket, 2% error rate"
                            } %>
                      </div>
                      <div class="col-md-6">
                        <%= ff.input :target_improvement,
                            label: "Target Improvement / ROI Goal",
                            input_html: {
                              class: "form-control form-control-lg",
                              placeholder: "e.g., Cut cycle time 50%, Save $5k/month"
                            } %>
                      </div>
                    </div>

                    <div class="row g-4 mt-2">
                      <div class="col-md-12">
                        <%= ff.input :manual_tasks_friction,
                            as: :text,
                            label: "Manual Tasks Creating Friction",
                            input_html: {
                              class: "form-control form-control-lg",
                              rows: 4,
                              placeholder: "• List the repetitive tasks\n• That are slowing you down\n• And could be automated"
                            } %>
                      </div>
                    </div>
                  </div>

                  <div class="section-footer p-4 text-center">
                    <button type="button" class="btn btn-outline-secondary btn-lg me-3"
                      data-action="click->analysis#showSection"
                      data-section-number-value="2">
                      <i class="fas fa-arrow-left me-2"></i>Back
                    </button>
                    <button type="button" data-action="click->analysis#showSection" data-section-number-value="4">
                      Continue to Tools <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                  </div>
                </div>

                <!-- Section 4: Tools & Process Context -->
                <div class="form-section d-none" id="section-4">
                  <div class="section-header bg-info text-white p-4">
                    <h4 class="mb-0"><i class="fas fa-tools me-3"></i>Tools & Process Context</h4>
                    <small class="opacity-75">Tell us about your current tech stack</small>
                  </div>

                  <div class="section-content bg-light p-5">
                    <div class="row g-4">
                      <div class="col-md-12">
                        <label class="form-label">Existing Tools/Stack</label>
                        <div id="tools-container" class="mb-3">
                          <!-- Tools cards aparecen aquí dinámicamente -->
                        </div>

                        <div class="input-group position-relative">
                          <input type="text"
                                class="form-control form-control-lg"
                                id="tools-input"
                                placeholder="Type or select a tool (e.g., HubSpot, Slack)"
                                data-action="keydown->analysis#addToolKeydown input->analysis#filterTools focus->analysis#showToolSuggestions"
                                autocomplete="off">
                          <button class="btn btn-outline-secondary" type="button" data-action="click->analysis#addToolFromInput">
                            <i class="fas fa-plus"></i> Add Tool
                          </button>

                          <!-- Dropdown de sugerencias para tools -->
                          <div class="tools-suggestions position-absolute w-100 bg-white border rounded shadow-sm"
                              id="tools-suggestions"
                              style="display: none; top: 100%; z-index: 1000; max-height: 200px; overflow-y: auto;">
                          </div>
                        </div>

                        <small class="text-muted">Add tools you currently use. Each tool will have fields for subscription details and integrations.</small>

                        <%= ff.input :existing_tools_data, as: :hidden, input_html: { id: "tools_data_hidden" } %>
                      </div>

                    <div class="row g-4 mt-2">
                      <div class="col-md-6">
                        <%= ff.input :tried_automating,
                            as: :select,
                            collection: [
                              ['Yes – worked', 'yes_worked'],
                              ['Yes – failed', 'yes_failed'],
                              ['Considering', 'considering'],
                              ['Not yet', 'not_yet']
                            ],
                            label: "Have You Tried Automating?",
                            input_html: { class: "form-select form-select-lg" },
                            include_blank: "Select option" %>
                      </div>
                    </div>
                  </div>

                  <div class="section-footer p-4 text-center">
                    <button type="button" class="btn btn-outline-secondary btn-lg me-3"
                      data-action="click->analysis#showSection"
                      data-section-number-value="3">
                      <i class="fas fa-arrow-left me-2"></i>Back
                    </button>
                    <button type="button" data-action="click->analysis#showSection" data-section-number-value="5">
                      Continue to Compliance <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                  </div>
                </div>

                <!-- Section 5: Constraints & Compliance -->
                <div class="form-section d-none" id="section-5">
                  <div class="section-header bg-danger text-white p-4">
                    <h4 class="mb-0"><i class="fas fa-shield-alt me-3"></i>Constraints & Compliance</h4>
                    <small class="opacity-75">Security and regulatory requirements</small>
                  </div>

                  <div class="section-content bg-light p-5">
                    <div class="row g-4">
                      <div class="col-md-6">
                        <%= ff.input :data_residency_needs,
                            as: :select,
                            collection: [
                              ['US-only', 'us_only'],
                              ['EU-only', 'eu_only'],
                              ['Mixed', 'mixed'],
                              ['No preference', 'no_preference']
                            ],
                            label: "Data Residency Needs",
                            input_html: { class: "form-select form-select-lg" },
                            include_blank: "Select preference" %>
                      </div>
                      <div class="col-md-6">
                        <%= ff.input :regulatory_other,
                            label: "Regulatory Requirements",
                            input_html: {
                              class: "form-control form-control-lg",
                              placeholder: "e.g., GDPR, HIPAA, SOC 2, etc."
                            } %>
                      </div>
                    </div>

                    <div class="row g-4 mt-2">
                      <div class="col-md-12">
                        <%= ff.input :security_other,
                            label: "Security Requirements",
                            input_html: {
                              class: "form-control form-control-lg",
                              placeholder: "e.g., SSO, Encryption at rest, Background checks, etc."
                            } %>
                      </div>
                    </div>
                  </div>

                  <div class="section-footer p-4 text-center">
                    <button type="button" class="btn btn-outline-secondary btn-lg me-3"
                      data-action="click->analysis#showSection"
                      data-section-number-value="4">
                      <i class="fas fa-arrow-left me-2"></i>Back
                    </button>
                    <%= f.button :submit,
                        "🚀 Run StaffCraft Analysis",
                        class: "btn btn-danger btn-lg px-5",
                        id: "submit-button" %>
                  </div>
                </div>

              <% end %>

            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
